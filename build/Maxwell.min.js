/*! Maxwell 2014-11-09 */
(function(){define(["cs!MatrixStamper","cs!GroundElm","cs!RailElm","cs!VoltageElm","cs!WireElm","cs!Pathfinder","cs!CircuitNode","cs!CircuitNodeLink","cs!RowInfo","cs!Settings","cs!ArrayUtils"],function(a,b,c,d,e,f,g,h,i,j,k){var l;return l=function(){function b(b){this.Circuit=b,this.scaleFactors=k.zeroArray(400),this.reset(),this.Stamper=new a(this.Circuit)}return b.prototype.reset=function(){return this.time=0,this.converged=!0,this.subIterations=5e3,this.circuitMatrix=[],this.circuitRightSide=[],this.origMatrix=[],this.origRightSide=[],this.circuitRowInfo=[],this.circuitPermute=[],this.circuitNonLinear=!1,this.lastFrameTime=0,this.lastIterTime=0,this.frames=0,this.lastTime=0,this.invalidate()},b.prototype.invalidate=function(){return this.analyzeFlag=!0},b.prototype.needsRemap=function(){return this.analyzeFlag},b.prototype.pause=function(a){return null==a&&(a="Simulator stopped"),Logger.log(a),this.isStopped=!0},b.prototype.run=function(a){return null==a&&(a="Simulator running"),Logger.log(a),this.isStopped=!1},b.prototype.getSimSpeed=function(){return 0===j.SPEED?0:.1*Math.exp((j.SPEED-61)/24)},b.prototype.reconstruct=function(){var a,b,c,j,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb,ob,pb,qb,rb,sb,tb,ub,vb,wb,xb,yb,zb,Ab,Bb,Cb,Db,Eb;if(this.analyzeFlag&&0!==this.Circuit.numElements()){for(this.Circuit.getCircuitBottom(),this.Circuit.clearErrors(),this.Circuit.resetNodes(),T=0,q=!1,r=!1,S=null,hb=this.Circuit.getElements(),V=0,Z=hb.length;Z>V;V++){if(j=hb[V],"GroundElm"===j.toString()){this.gotGround=!0;break}"RailElm"===j.toString&&(r=!0),null==S&&"VoltageElm"===j.toString()&&(S=j)}for(l=new g,q||null==S||r?l.x=l.y=-1:(R=S.getPost(0),l.x=R.x,l.y=R.y),this.Circuit.addCircuitNode(l),s=W=0,ib=this.Circuit.numElements();ib>=0?ib>W:W>ib;s=ib>=0?++W:--W){for(j=this.Circuit.getElmByIdx(s),u=j.getInternalNodeCount(),v=j.getVoltageSourceCount(),H=j.getPostCount(),x=X=0;H>=0?H>X:X>H;x=H>=0?++X:--X){for(I=j.getPost(x),y=0,ob=this.Circuit.getNodes(),Y=0,$=ob.length;$>Y&&(F=ob[Y],I.x!==F.x||I.y!==F.y);Y++)y++;y===this.Circuit.numNodes()?(l=new g,l.x=I.x,l.y=I.y,m=new h,m.num=x,m.elm=j,l.links.push(m),j.setNode(x,this.Circuit.numNodes()),this.Circuit.addCircuitNode(l)):(m=new h,m.num=x,m.elm=j,this.Circuit.getNode(y).links.push(m),j.setNode(x,y),0===y&&j.setNodeVoltage(x,0))}for(x=bb=0;u>=0?u>bb:bb>u;x=u>=0?++bb:--bb)l=new g(-1,-1,!0),m=new h,m.num=x+H,m.elm=j,l.links.push(m),j.setNode(m.num,this.Circuit.numNodes()),this.Circuit.addCircuitNode(l);T+=v}for(this.Circuit.voltageSources=new Array(T),T=0,this.circuitNonLinear=!1,pb=this.Circuit.getElements(),cb=0,_=pb.length;_>cb;cb++)for(c=pb[cb],c.nonLinear()&&(this.circuitNonLinear=!0),v=c.getVoltageSourceCount(),x=db=0;v>=0?v>db:db>v;x=v>=0?++db:--db)this.Circuit.voltageSources[T]=c,c.setVoltageSource(x,T++);for(this.Circuit.voltageSourceCount=T,this.matrixSize=this.Circuit.numNodes()-1+T,this.circuitMatrixSize=this.circuitMatrixFullSize=this.matrixSize,this.circuitMatrix=k.zeroArray2(this.matrixSize,this.matrixSize),this.origMatrix=k.zeroArray2(this.matrixSize,this.matrixSize),this.circuitRightSide=k.zeroArray(this.matrixSize),this.origRightSide=k.zeroArray(this.matrixSize),this.circuitRowInfo=k.zeroArray(this.matrixSize),this.circuitPermute=k.zeroArray(this.matrixSize),s=eb=0,qb=this.matrixSize;qb>=0?qb>eb:eb>qb;s=qb>=0?++eb:--eb)this.circuitRowInfo[s]=new i;for(this.circuitNeedsMap=!1,rb=this.Circuit.getElements(),fb=0,ab=rb.length;ab>fb;fb++)j=rb[fb],j.stamp(this.Stamper);for(o=new Array(this.Circuit.numNodes()),o[0]=!0;b;){for(b=!1,s=0;s!==this.Circuit.numElements();){for(j=this.Circuit.getElm(s),x=0;x<j.getPostCount();)if(o[j.getNode(x)]){for(y=0;y!==j.getPostCount();)x!==y&&(z=j.getNode(y),j.getConnection(x,y)&&!o[z]&&(o[z]=!0,b=!0),++y);++x}else j.hasGroundConnection(x)&&(b=!0,o[j.getNode(x)]=!0);++s}if(!b)for(s=gb=0,sb=this.Circuit.numNodes();sb>=0?sb>gb:gb>sb;s=sb>=0?++gb:--gb)if(!o[s]&&!this.Circuit.getCircuitNode(s).intern){this.Stamper.stampResistor(0,s,1e8),o[s]=!0,b=!0;break}}for(s=xb=0,tb=this.Circuit.numElements();tb>=0?tb>xb:xb>tb;s=tb>=0?++xb:--xb)a=this.Circuit.getElmByIdx(s),(a instanceof d&&2===a.getPostCount()||a instanceof e)&&(G=new f(f.VOLTAGE,a,a.getNode(1),this.Circuit.getElements(),this.Circuit.numNodes()));for(w=0;w<this.matrixSize;)if(J=-1,K=-1,M=0,N=this.circuitRowInfo[w],N.lsChanges||N.dropRow||N.rsChanges)w++;else{for(Q=0,x=yb=0,ub=this.matrixSize;ub>=0?ub>yb:yb>ub;x=ub>=0?++yb:--yb)if(A=this.circuitMatrix[w][x],this.circuitRowInfo[x].type!==i.ROW_CONST){if(0!==A)if(-1!==K){if(-1!==J||A!==-M)break;J=x}else K=x,M=A}else Q-=this.circuitRowInfo[x].value*A;if(x===this.matrixSize){if(-1===K)return this.circuitRowInfo[x].type,void this.Circuit.halt("Matrix error qp",null);if(p=this.circuitRowInfo[K],-1===J){for(y=0;p.type===i.ROW_EQUAL&&100>y;)K=p.nodeEq,p=this.circuitRowInfo[K],++y;if(p.type===i.ROW_EQUAL){p.type=i.ROW_NORMAL,w++;continue}if(p.type!==i.ROW_NORMAL){w++;continue}p.type=i.ROW_CONST,p.value=(this.circuitRightSide[w]+Q)/M,this.circuitRowInfo[w].dropRow=!0,w=-1}else if(this.circuitRightSide[w]+Q===0){if(p.type!==i.ROW_NORMAL&&(L=J,J=K,K=L,p=this.circuitRowInfo[K],p.type!==i.ROW_NORMAL)){w++;continue}p.type=i.ROW_EQUAL,p.nodeEq=J,this.circuitRowInfo[w].dropRow=!0}}w++}for(B=0,s=zb=0,vb=this.matrixSize;vb>=0?vb>zb:zb>vb;s=vb>=0?++zb:--zb)if(O=this.circuitRowInfo[s],O.type!==i.ROW_NORMAL){if(O.type===i.ROW_EQUAL)for(;x!==function(){for(wb=[],Ab=0;100>Ab;Ab++)wb.push(Ab);return wb}.apply(this)&&(P=this.circuitRowInfo[O.nodeEq],P.type===i.ROW_EQUAL)&&s!==P.nodeEq;)O.nodeEq=P.nodeEq;O.type===i.ROW_CONST&&(O.mapCol=-1)}else O.mapCol=B++;for(s=Bb=0,jb=this.matrixSize;jb>=0?jb>Bb:Bb>jb;s=jb>=0?++Bb:--Bb)O=this.circuitRowInfo[s],O.type===i.ROW_EQUAL&&(P=this.circuitRowInfo[O.nodeEq],P.type===i.ROW_CONST?(O.type=P.type,O.value=P.value,O.mapCol=-1):O.mapCol=P.mapCol);for(E=B,C=k.zeroArray2(E,E),D=new Array(E),k.zeroArray(D),t=0,s=0;s!==this.matrixSize;)if(n=this.circuitRowInfo[s],n.dropRow)n.mapRow=-1,s++;else{for(D[t]=this.circuitRightSide[s],n.mapRow=t,x=Cb=0,kb=this.matrixSize;kb>=0?kb>Cb:Cb>kb;x=kb>=0?++Cb:--Cb)O=this.circuitRowInfo[x],O.type===i.ROW_CONST?D[t]-=O.value*this.circuitMatrix[s][x]:C[t][O.mapCol]+=this.circuitMatrix[s][x];t++,s++}for(this.circuitMatrix=C,this.circuitRightSide=D,this.matrixSize=this.circuitMatrixSize=E,s=Db=0,lb=this.matrixSize;lb>=0?lb>Db:Db>lb;s=lb>=0?++Db:--Db)this.origRightSide[s]=this.circuitRightSide[s];for(s=Eb=0,mb=this.matrixSize;mb>=0?mb>Eb:Eb>mb;s=mb>=0?++Eb:--Eb)for(x=U=0,nb=this.matrixSize;nb>=0?nb>U:U>nb;x=nb>=0?++U:--U)this.origMatrix[s][x]=this.circuitMatrix[s][x];this.circuitNeedsMap=!0,this.analyzeFlag=!1,this.circuitNonLinear||this.luFactor(this.circuitMatrix,this.circuitMatrixSize,this.circuitPermute)||this.Circuit.halt("Singular matrix!",null)}},b.prototype.solveCircuit=function(){var a,b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L;if(null==this.circuitMatrix||0===this.Circuit.numElements())return void(this.circuitMatrix=null);if(d=this.dumpMatrix,this.dumpMatrix=!1,n=Math.floor(160*this.getSimSpeed()),q=(new Date).getTime(),j=this.lastIterTime,!(1e3>=n*(q-this.lastIterTime))){for(f=1;;){for(E=this.Circuit.getElements(),r=0,v=E.length;v>r;r++)a=E[r],a.startIteration();for(++this.steps,p=500,o=s=0;p>=0?p>s:s>p;o=p>=0?++s:--s){for(this.converged=!0,this.subIterations=o,e=t=0,F=this.circuitMatrixSize;F>=0?F>t:t>F;e=F>=0?++t:--t)this.circuitRightSide[e]=this.origRightSide[e];if(this.circuitNonLinear)for(e=u=0,G=this.circuitMatrixSize;G>=0?G>u:u>G;e=G>=0?++u:--u)for(g=z=0,H=this.circuitMatrixSize;H>=0?H>z:z>H;g=H>=0?++z:--z)this.circuitMatrix[e][g]=this.origMatrix[e][g];for(I=this.Circuit.getElements(),A=0,w=I.length;w>A;A++)a=I[A],a.doStep();if(null!=this.stopMessage)return;if(d=!1,this.circuitNonLinear){if(this.converged&&o>0)break;if(!this.luFactor(this.circuitMatrix,this.circuitMatrixSize,this.circuitPermute))return void this.Circuit.halt("Singular matrix!",null)}for(this.luSolve(this.circuitMatrix,this.circuitMatrixSize,this.circuitPermute,this.circuitRightSide),g=B=0,J=this.circuitMatrixFullSize;J>=0?J>B:B>J;g=J>=0?++B:--B){if(l=this.circuitRowInfo[g],k=0,k=l.type===i.ROW_CONST?l.value:this.circuitRightSide[l.mapCol],isNaN(k)){this.converged=!1;break}if(g<this.Circuit.numNodes()-1)for(b=this.Circuit.getNode(g+1),K=b.links,C=0,x=K.length;x>C;C++)c=K[C],c.elm.setNodeVoltage(c.num,k);else h=g-(this.Circuit.numNodes()-1),this.Circuit.voltageSources[h].setCurrent(h,k)}if(!this.circuitNonLinear)break;o++}if(o>=p){this.halt("Convergence failed: "+o,null);break}for(this.time+=this.timeStep,L=this.Circuit.scopes,D=0,y=L.length;y>D;D++)m=L[D],m.timeStep();if(q=(new Date).getTime(),j=q,1e3*f>=n*(q-this.lastIterTime))break;if(q-this.lastFrameTime>500)break;++f}return this.lastIterTime=j}},b.prototype.luFactor=function(a,b,c){var d,e,f,g,h,i,j,k;for(d=0;b>d;){for(g=0,e=0;b>e;)k=Math.abs(a[d][e]),k>g&&(g=k),++e;if(0===g)return!1;this.scaleFactors[d]=1/g,++d}for(e=0;b>e;){for(d=0;e>d;){for(i=a[d][e],f=0;f!==d;)i-=a[d][f]*a[f][e],++f;a[d][e]=i,++d}for(g=0,h=-1,d=e;b>d;){for(i=a[d][e],f=0;e>f;)i-=a[d][f]*a[f][e],++f;a[d][e]=i,k=Math.abs(i),k>=g&&(g=k,h=d),++d}if(e!==h){for(f=0;b>f;)k=a[h][f],a[h][f]=a[e][f],a[e][f]=k,++f;this.scaleFactors[h]=this.scaleFactors[e]}if(c[e]=h,0===a[e][e]&&(a[e][e]=1e-18),e!==b-1)for(j=1/a[e][e],d=e+1;d!==b;)a[d][e]*=j,++d;++e}return!0},b.prototype.luSolve=function(a,b,c,d){var e,f,g,h,i,j,k,l;for(f=0;b>f&&(h=c[f],i=d[h],d[h]=d[f],d[f]=i,0===i);)++f;for(e=f++;b>f;){for(h=c[f],j=d[h],d[h]=d[f],g=e;f>g;)j-=a[f][g]*d[g],++g;d[f]=j,++f}for(f=b-1,l=[];f>=0;){for(k=d[f],g=f+1;g!==b;)k-=a[f][g]*d[g],++g;d[f]=k/a[f][f],l.push(f--)}return l},b.prototype.updateVoltageSource=function(a,b,c,d){var e;return e=this.Circuit.numNodes()+c,this.Stamper.stampRightSide(e,d)},b}()})}).call(this),function(){define([],function(){var a;return a=function(){function a(a,b,c,d){this.x=null!=a?a:0,this.y=null!=b?b:0,this.intern=null!=c?c:!1,this.links=null!=d?d:[]}return a.prototype.toString=function(){return"CircuitNode: "+this.x+" "+this.y+" "+this.intern+" ["+this.links.toString()+"]"},a}()})}.call(this),function(){define([],function(){var a;return a=function(){function a(a,b){this.num=null!=a?a:0,this.elm=null!=b?b:null}return a.prototype.toString=function(){return""+this.num+" "+this.elm.toString()},a}()})}.call(this),function(){define(["cs!VoltageElm"],function(a){var b;return b=function(){function b(a,b,c,d,e){this.type=a,this.firstElm=b,this.dest=c,this.elementList=d,this.used=new Array(e)}return b.INDUCT=1,b.VOLTAGE=2,b.SHORT=3,b.CAP_V=4,b.prototype.findPath=function(c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(c===this.dest)return!0;if(0===d--||this.used[c])return!1;for(this.used[c]=!0,q=this.elementList,j=0,n=q.length;n>j;j++)if(f=q[j],f!==this.firstElm&&(this.type!==b.VOLTAGE||!(f.isWire()||f instanceof a))&&(this.type!==b.SHORT||f.isWire())&&(this.type!==b.CAP_V||f.isWire()||f instanceof CapacitorElm||f instanceof a)){if(0===c)for(r=Array(f.getPostCount()),k=0,o=r.length;o>k;k++)if(g=r[k],f.hasGroundConnection(g)&&this.findPath(f.getNode(g),d))return this.used[c]=!1,!0;for(i=0,s=Array(f.getPostCount()),l=0,p=s.length;p>l&&(i=s[l],f.getNode(i)!==c);l++);if(i!==f.getPostCount()){if(f.hasGroundConnection(i)&&this.findPath(0,d))return this.used[c]=!1,!0;if(!(this.type===b.INDUCT&&f instanceof InductorElm&&(e=f.getCurrent(),0===i&&(e=-e),Math.abs(e-this.firstElm.getCurrent())>1e-10)))for(h=m=0,t=f.getPostCount();t>=0?t>m:m>t;h=t>=0?++m:--m)if(i!==h&&f.getConnection(i,h)&&this.findPath(f.getNode(h),d))return this.used[c]=!1,!0}}return this.used[c]=!1,!1},b}()})}.call(this),function(){define([],function(){var a;return a=function(){function a(a){this.Circuit=a}return a.HINT_LC="HINT_LC",a.HINT_RC="HINT_RC",a.HINT_3DB_C="HINT_3DB_C",a.HINT_TWINT="HINT_TWINT",a.HINT_3DB_L="HINT_3DB_L",a.hintType=-1,a.hintItem1=-1,a.hintItem2=-1,a.prototype.readHint=function(a){return"string"==typeof a&&(a=a.split(" ")),this.hintType=a[0],this.hintItem1=a[1],this.hintItem2=a[2]},a.prototype.getHint=function(){var a,b,c,d,e;return a=this.Circuit.getElmByIdx(this.hintItem1),b=this.Circuit.getElmByIdx(this.hintItem2),null==a||null==b?null:this.hintType===this.HINT_LC?a instanceof InductorElm&&b instanceof CapacitorElm?(d=a,c=b,"res.f = "+getUnitText(1/(2*Math.PI*Math.sqrt(d.inductance*c.capacitance)),"Hz")):null:this.hintType===this.HINT_RC?a instanceof ResistorElm&&b instanceof CapacitorElm?(e=a,c=b,"RC = "+getUnitText(e.resistance*c.capacitance,"s")):null:this.hintType===this.HINT_3DB_C?a instanceof ResistorElm&&b instanceof CapacitorElm?(e=a,c=b,"f.3db = "+getUnitText(1/(2*Math.PI*e.resistance*c.capacitance),"Hz")):null:this.hintType===this.HINT_3DB_L?a instanceof ResistorElm&&b instanceof InductorElm?(e=a,d=b,"f.3db = "+getUnitText(e.resistance/(2*Math.PI*d.inductance),"Hz")):null:this.hintType===this.HINT_TWINT&&a instanceof ResistorElm&&b instanceof CapacitorElm?(e=a,c=b,"fc = "+getUnitText(1/(2*Math.PI*e.resistance*c.capacitance),"Hz")):null},a}()})}.call(this),function(){define(["cs!MathUtils"],function(a){var b;return b=function(){function b(a){this.Circuit=a}return b.prototype.stampVCVS=function(a,b,c,d){var e;return e=this.Circuit.numNodes()+d,this.stampMatrix(e,a,c),this.stampMatrix(e,b,-c)},b.prototype.stampVoltageSource=function(a,b,c,d){var e;return e=this.Circuit.numNodes()+c,this.stampMatrix(e,a,-1),this.stampMatrix(e,b,1),this.stampRightSide(e,d),this.stampMatrix(a,e,1),this.stampMatrix(b,e,-1)},b.prototype.updateVoltageSource=function(a,b,c,d){var e;return e=this.Circuit.numNodes()+c,this.stampRightSide(e,d)},b.prototype.stampResistor=function(b,c,d){var e,f;return f=1/d,(isNaN(f)||a.isInfinite(f))&&(this.Circuit.halt("bad resistance"),e=0,e/=e),this.stampMatrix(b,b,f),this.stampMatrix(c,c,f),this.stampMatrix(b,c,-f),this.stampMatrix(c,b,-f)},b.prototype.stampConductance=function(a,b,c){return this.stampMatrix(a,a,c),this.stampMatrix(b,b,c),this.stampMatrix(a,b,-c),this.stampMatrix(b,a,-c)},b.prototype.stampVCCurrentSource=function(a,b,c,d,e){return this.stampMatrix(a,c,e),this.stampMatrix(b,d,e),this.stampMatrix(a,d,-e),this.stampMatrix(b,c,-e)},b.prototype.stampCurrentSource=function(a,b,c){return this.stampRightSide(a,-c),this.stampRightSide(b,c)},b.prototype.stampCCCS=function(a,b,c,d){var e;return e=this.Circuit.numNodes()+c,this.stampMatrix(a,e,d),this.stampMatrix(b,e,-d)},b.prototype.stampMatrix=function(a,b,c){var d;if(a>0&&b>0){if(this.Circuit.Solver.circuitNeedsMap){if(a=this.Circuit.Solver.circuitRowInfo[a-1].mapRow,d=this.Circuit.Solver.circuitRowInfo[b-1],d.type===RowInfo.ROW_CONST)return void(this.Circuit.Solver.circuitRightSide[a]-=c*d.value);b=d.mapCol}else a--,b--;return this.Circuit.Solver.circuitMatrix[a][b]+=c}},b.prototype.stampRightSide=function(a,b){if(isNaN(b)){if(a>0)return this.Circuit.Solver.circuitRowInfo[a-1].rsChanges=!0}else if(a>0)return this.Circuit.Solver.circuitNeedsMap?a=this.Circuit.Solver.circuitRowInfo[a-1].mapRow:a--,this.Circuit.Solver.circuitRightSide[a]+=b},b.prototype.stampNonLinear=function(a){return a>0?this.Circuit.Solver.circuitRowInfo[a-1].lsChanges=!0:void 0},b}()})}.call(this),function(){define([],function(){var a;return a=function(){function a(){this.type=a.ROW_NORMAL,this.nodeEq=0,this.mapCol=0,this.mapRow=0,this.value=0,this.rsChanges=!1,this.lsChanges=!1,this.dropRow=!1}return a.ROW_NORMAL=0,a.ROW_CONST=1,a.ROW_EQUAL=2,a.prototype.toString=function(){return"RowInfo: "+this.type+" "+this.nodeEq+" "+this.mapCol+" "+this.mapRow+" "+this.value+" "+this.rsChanges+" "+this.lsChanges+" "+this.dropRow},a}()})}.call(this);